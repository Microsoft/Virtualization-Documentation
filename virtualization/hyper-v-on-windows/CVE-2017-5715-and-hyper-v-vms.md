# Protecting guest virtual machines from CVE-2017-5715 (branch target injection)

In addition to [this guidance](https://support.microsoft.com/en-us/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution), the following steps are required to ensure that your virtual machines are protected from CVE-2017-5715 (branch target injection):

1.	Ensure guest virtual machines have access to the updated firmware.
2.	Update the guest operating system as required.
3.	Perform a cold boot of guest virtual machines.

## Ensure guest virtual machines have access to the updated firmware

By default, virtual machines with a VM version below 8.0 will not have access to updated firmware capabilities required to mitigate CVE-2017-5715.  Because VM version 8.0 is only available starting with Windows Server 2016, users of Windows Server 2012 R2 or earlier must modify a specific registry value on all machines in their cluster.

That registry value is `MinVmVersionForCpuBasedMitigations` under `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization` on the host.  The value should be set to the minimum VM version that needs access to the updated firmware capabilities, in the format “Major.Minor”.  To expose the firmware to all virtual machines on the operating system (i.e. version 1.0 and above), run the following command on the host: 
 
```
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization" /v MinVmVersionForCpuBasedMitigations /t REG_SZ /d "1.0" /f
```
*Warning: live migration will fail between hosts with the updated firmware and hosts without the updated firmware.  For more details, see the "Migrating virtual machines between patched and unpatched Hyper-V hosts" section at the bottom of this document.*

## Update the guest operating system

The guest operating system must be updated take advantage of the new firmware capabilities exposed by Hyper-V.  For Microsoft operating systems, please follow the guidance in [this article](https://support.microsoft.com/en-us/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution) when updating.

Note: updating the guest operating system can occur at any time in this process.


## Perform a cold boot of the guest

Virtual machines will not see the updated firmware capabilities until they go through a cold boot.  This means the running VMs must completely power off before starting again.  Rebooting from inside the guest operating system is not sufficient.

One way to shut down virtual machines on a host is to use the `Stop-VM` cmdlet.  One way to start virtual machines that are powered off is the `Start-VM` cmdlet.  


## Migrating virtual machines between patched and unpatched Hyper-V hosts

Migration of a virtual machine with the updated firmware capabilities will fail when moving to Hyper-V hosts without updated firmware.  To enable live migration in these scenarios, modify `MinVmVersionForCpuBasedMitigations` to a VM version above that of the VM that needs to migrate, and perform a cold boot of the guest virtual machine.

Migration of a virtual machine without the updated firmware capabilities will succeed when moving to Hyper-V hosts with the updated firmware.  However, a cold boot is required for these guests to see the updated firmware capabilities.



